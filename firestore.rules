rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isLoggedIn() {
      return request.auth != null;
    }
    function isTeacher() {
      return isLoggedIn()
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "teacher";
    }
    function isOwner(uid) {
      return isLoggedIn() && request.auth.uid == uid;
    }
    function isCourseOwner(courseId) {
      return isTeacher()
        && get(/databases/$(database)/documents/courses/$(courseId)).data.ownerUid == request.auth.uid;
    }
    function isEnrolledStudent(courseId) {
      return isLoggedIn()
        && courseId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.enrolledCourses;
    }
    function hasCourseAccess(courseId) {
      return isCourseOwner(courseId) || isEnrolledStudent(courseId);
    }
    match /users/{uid} {
      allow read: if isLoggedIn();
      allow write: if isOwner(uid) || isTeacher();

      // Notifications: owner can read/write, teachers can create (for fan-out)
      match /notifications/{notifId} {
        allow read, write: if isOwner(uid);
        allow create: if isTeacher();
      }
    }
    match /courses/{courseId} {
      allow read: if isLoggedIn();
      allow create: if isTeacher();
      allow update, delete: if isCourseOwner(courseId);
      match /lessons/{lessonId} {
        allow read: if hasCourseAccess(courseId);
        allow write: if isCourseOwner(courseId);
      }
      // Announcements: enrolled students + teacher can read, course owner can write
      match /announcements/{annId} {
        allow read: if hasCourseAccess(courseId);
        allow write: if isCourseOwner(courseId);
      }
      match /settings/{settingId} {
        allow read: if hasCourseAccess(courseId);
        allow write: if isCourseOwner(courseId);
      }
      match /teams/{teamId} {
        allow read: if hasCourseAccess(courseId);
        allow write: if isCourseOwner(courseId);
      }
      match /mana/{docId} {
        allow read: if hasCourseAccess(courseId);
        allow write: if isCourseOwner(courseId);
      }
      match /bossBattles/{battleId} {
        allow read: if hasCourseAccess(courseId);
        allow write: if isCourseOwner(courseId);
      }
      match /gamification/{uid} {
        allow read: if hasCourseAccess(courseId);
        allow write: if isOwner(uid) || isCourseOwner(courseId);
      }
      match /chatLogs/{lessonId}/{blockId}/{studentId} {
        allow read: if hasCourseAccess(courseId);
        allow write: if isOwner(studentId) || isCourseOwner(courseId);
      }
      match /perkRequests/{requestId} {
        allow read: if hasCourseAccess(courseId);
        allow create: if hasCourseAccess(courseId);
        allow update, delete: if isCourseOwner(courseId);
      }
      match /enrollments/{uid} {
        allow read: if hasCourseAccess(courseId);
        allow write: if isOwner(uid) || isCourseOwner(courseId);
      }
      // Grades (teacher-graded entries + reflection gradebook)
      match /grades/{gradeId} {
        allow read: if hasCourseAccess(courseId);
        // Teachers can write any grade; students can only write their own reflection grades
        allow write: if isCourseOwner(courseId)
          || (isEnrolledStudent(courseId)
              && gradeId.matches("reflection_" + request.auth.uid + "_.*")
              && request.resource.data.studentId == request.auth.uid);
      }
      // Reflections (read by MyGrades + StudentProgress)
      match /reflections/{reflectionId} {
        allow read: if hasCourseAccess(courseId);
        // Teachers can write any reflection; students can only write their own
        // Cloud Function uses admin SDK and bypasses these rules
        allow write: if isCourseOwner(courseId)
          || (isEnrolledStudent(courseId)
              && reflectionId.matches(request.auth.uid + "_.*")
              && request.resource.data.studentId == request.auth.uid);
      }
      match /chats/{chatId} {
        allow read: if isTeacher()
          || (isLoggedIn() && request.auth.uid in resource.data.members);
        allow create: if hasCourseAccess(courseId);
        allow update: if isLoggedIn()
          && request.auth.uid in resource.data.members;

        match /messages/{messageId} {
          allow read: if isTeacher()
            || (isLoggedIn() && request.auth.uid in get(/databases/$(database)/documents/courses/$(courseId)/chats/$(chatId)).data.members);
          allow create: if isLoggedIn()
            && request.auth.uid in get(/databases/$(database)/documents/courses/$(courseId)/chats/$(chatId)).data.members;
        }

        match /readBy/{userId} {
          allow read, write: if isLoggedIn() && request.auth.uid == userId;
          allow read: if isTeacher();
        }
      }
    }
    // Legacy global gamification (backward compat)
    match /gamification/{uid} {
      allow read: if isLoggedIn();
      allow write: if isOwner(uid) || isTeacher();
    }
    match /progress/{uid}/{document=**} {
      allow read: if isOwner(uid) || isTeacher();
      allow write: if isOwner(uid) || isTeacher();
    }
    match /enrollments/{enrollmentId} {
      allow read: if isLoggedIn();
      allow write: if isTeacher()
        || (isLoggedIn() && resource.data.email == request.auth.token.email);
    }
    match /chatLogs/{uid}/{document=**} {
      allow read: if isOwner(uid) || isTeacher();
      allow write: if isOwner(uid) || isTeacher();
    }
    match /rateLimits/{uid} {
      allow read, write: if isOwner(uid);
    }
  }
}
