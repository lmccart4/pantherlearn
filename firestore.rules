rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isLoggedIn() {
      return request.auth != null;
    }
    function isTeacher() {
      return isLoggedIn()
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "teacher";
    }
    function isOwner(uid) {
      return isLoggedIn() && request.auth.uid == uid;
    }
    function isCourseOwner(courseId) {
      return isTeacher()
        && get(/databases/$(database)/documents/courses/$(courseId)).data.ownerUid == request.auth.uid;
    }
    function isEnrolledStudent(courseId) {
      return isLoggedIn()
        && courseId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.enrolledCourses;
    }
    function hasCourseAccess(courseId) {
      return isCourseOwner(courseId) || isEnrolledStudent(courseId);
    }
    match /users/{uid} {
      allow read: if isLoggedIn();
      allow write: if isOwner(uid) || isTeacher();
    }
    match /courses/{courseId} {
      allow read: if isLoggedIn();
      allow create: if isTeacher();
      allow update, delete: if isCourseOwner(courseId);
      match /lessons/{lessonId} {
        allow read: if hasCourseAccess(courseId);
        allow write: if isCourseOwner(courseId);
      }
      match /settings/{settingId} {
        allow read: if hasCourseAccess(courseId);
        allow write: if isCourseOwner(courseId);
      }
      // FIX #11: Only teachers can modify teams
      match /teams/{teamId} {
        allow read: if hasCourseAccess(courseId);
        allow write: if isCourseOwner(courseId);
      }
      // FIX #11: Only teachers can modify mana
      match /mana/{docId} {
        allow read: if hasCourseAccess(courseId);
        allow write: if isCourseOwner(courseId);
      }
      // FIX #11: Only teachers can modify boss battles
      match /bossBattles/{battleId} {
        allow read: if hasCourseAccess(courseId);
        allow write: if isCourseOwner(courseId);
      }
      // Per-course gamification (Phase 2)
      match /gamification/{uid} {
        allow read: if hasCourseAccess(courseId);
        allow write: if isOwner(uid) || isCourseOwner(courseId);
      }
      // Per-course chat logs (Phase 2)
      // FIX #9: Only the student who owns the log or the course teacher can write
      match /chatLogs/{lessonId}/{blockId}/{studentId} {
        allow read: if hasCourseAccess(courseId);
        allow write: if isOwner(studentId) || isCourseOwner(courseId);
      }
      // Perk requests
      match /perkRequests/{requestId} {
        allow read: if hasCourseAccess(courseId);
        allow create: if hasCourseAccess(courseId);
        allow update, delete: if isCourseOwner(courseId);
      }
      // Enrollments subcollection
      match /enrollments/{uid} {
        allow read: if hasCourseAccess(courseId);
        allow write: if isOwner(uid) || isCourseOwner(courseId);
      }
      // Class chat rooms
      match /chats/{chatId} {
        allow read: if isTeacher()
          || (isLoggedIn() && request.auth.uid in resource.data.members);
        allow create: if hasCourseAccess(courseId);
        allow update: if isLoggedIn()
          && request.auth.uid in resource.data.members;

        match /messages/{messageId} {
          allow read: if isTeacher()
            || (isLoggedIn() && request.auth.uid in get(/databases/$(database)/documents/courses/$(courseId)/chats/$(chatId)).data.members);
          allow create: if isLoggedIn()
            && request.auth.uid in get(/databases/$(database)/documents/courses/$(courseId)/chats/$(chatId)).data.members;
        }

        match /readBy/{userId} {
          allow read, write: if isLoggedIn() && request.auth.uid == userId;
          allow read: if isTeacher();
        }
      }
    }
    // Legacy global gamification (backward compat)
    match /gamification/{uid} {
      allow read: if isLoggedIn();
      allow write: if isOwner(uid) || isTeacher();
    }
    match /progress/{uid}/{document=**} {
      allow read: if isOwner(uid) || isTeacher();
      allow write: if isOwner(uid) || isTeacher();
    }
    // FIX #8: Lock down legacy enrollments — teachers can read/write all, students can only read/write their own
    match /enrollments/{enrollmentId} {
      allow read: if isLoggedIn();
      allow write: if isTeacher()
        || (isLoggedIn() && resource.data.email == request.auth.token.email);
    }
    // FIX #9: Lock down legacy chatLogs — teachers can read/write, students can only read/write their own
    match /chatLogs/{uid}/{document=**} {
      allow read: if isOwner(uid) || isTeacher();
      allow write: if isOwner(uid) || isTeacher();
    }
    match /rateLimits/{uid} {
      allow read, write: if isOwner(uid);
    }
  }
}