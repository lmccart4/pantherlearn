rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isLoggedIn() {
      return request.auth != null;
    }
    function isTeacher() {
      return isLoggedIn()
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "teacher";
    }
    function isOwner(uid) {
      return isLoggedIn() && request.auth.uid == uid;
    }
    function isCourseOwner(courseId) {
      return isTeacher()
        && get(/databases/$(database)/documents/courses/$(courseId)).data.ownerUid == request.auth.uid;
    }
    // Co-teacher support: owner OR any teacher in the coTeachers array
    function isCourseTeacher(courseId) {
      let course = get(/databases/$(database)/documents/courses/$(courseId)).data;
      return isTeacher() && (
        course.ownerUid == request.auth.uid
        || (course.coTeachers != null && request.auth.uid in course.coTeachers)
      );
    }
    function isEnrolledStudent(courseId) {
      return isLoggedIn()
        && courseId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.enrolledCourses;
    }
    function hasCourseAccess(courseId) {
      return isCourseTeacher(courseId) || isEnrolledStudent(courseId);
    }
    match /users/{uid} {
      allow read: if isLoggedIn();
      allow write: if isOwner(uid) || isTeacher();

      // Notifications: owner can read/write, teachers can create (for fan-out)
      match /notifications/{notifId} {
        allow read, write: if isOwner(uid);
        allow create: if isTeacher();
      }
    }
    match /courses/{courseId} {
      allow read: if isLoggedIn();
      allow create: if isTeacher();
      // Co-teachers can update course doc; only owner can delete
      allow update: if isCourseTeacher(courseId);
      allow delete: if isCourseOwner(courseId);
      match /lessons/{lessonId} {
        allow read: if hasCourseAccess(courseId);
        allow write: if isCourseTeacher(courseId);
      }
      // Announcements: enrolled students + teacher can read, course teachers can write
      match /announcements/{annId} {
        allow read: if hasCourseAccess(courseId);
        allow write: if isCourseTeacher(courseId);
      }
      match /settings/{settingId} {
        allow read: if hasCourseAccess(courseId);
        allow write: if isCourseTeacher(courseId);
      }
      match /teams/{teamId} {
        allow read: if hasCourseAccess(courseId);
        allow write: if isCourseTeacher(courseId);
      }
      match /mana/{docId} {
        allow read: if hasCourseAccess(courseId);
        allow write: if isCourseTeacher(courseId);
      }
      match /bossBattles/{battleId} {
        allow read: if hasCourseAccess(courseId);
        allow write: if isCourseTeacher(courseId);
      }
      match /guessWhoGames/{gameId} {
        allow read: if hasCourseAccess(courseId);
        allow create: if hasCourseAccess(courseId);
        allow update: if hasCourseAccess(courseId);
      }
      match /gamification/{uid} {
        allow read: if hasCourseAccess(courseId);
        allow write: if isOwner(uid) || isCourseTeacher(courseId);
      }
      match /chatLogs/{lessonId}/{blockId}/{studentId} {
        // Students can only read their OWN chat logs; teachers can read all
        allow read: if isOwner(studentId) || isCourseTeacher(courseId);
        allow write: if isOwner(studentId) || isCourseTeacher(courseId);
      }
      match /perkRequests/{requestId} {
        allow read: if hasCourseAccess(courseId);
        allow create: if hasCourseAccess(courseId);
        allow update, delete: if isCourseTeacher(courseId);
      }
      match /enrollments/{uid} {
        allow read: if hasCourseAccess(courseId);
        allow write: if isOwner(uid) || isCourseTeacher(courseId);
      }
      // Grades (teacher-graded entries + reflection gradebook)
      match /grades/{gradeId} {
        // Students can only read their own grades; teachers can read all
        allow read: if isCourseTeacher(courseId)
          || (isEnrolledStudent(courseId)
              && gradeId.matches("reflection_" + request.auth.uid + "_.*"));
        // Teachers can write any grade; students can only write their own reflection grades
        allow write: if isCourseTeacher(courseId)
          || (isEnrolledStudent(courseId)
              && gradeId.matches("reflection_" + request.auth.uid + "_.*")
              && request.resource.data.studentId == request.auth.uid);
      }
      // Reflections (read by MyGrades + StudentProgress)
      match /reflections/{reflectionId} {
        // Students can only read their own reflections; teachers can read all
        allow read: if isCourseTeacher(courseId)
          || (isEnrolledStudent(courseId)
              && resource.data.studentId == request.auth.uid);
        // Teachers can write any reflection; students can only write their own
        // Cloud Function uses admin SDK and bypasses these rules
        allow write: if isCourseTeacher(courseId)
          || (isEnrolledStudent(courseId)
              && reflectionId.matches(request.auth.uid + "_.*")
              && request.resource.data.studentId == request.auth.uid);
      }
      match /chats/{chatId} {
        allow read: if isTeacher()
          || (isLoggedIn() && request.auth.uid in resource.data.members);
        allow create: if hasCourseAccess(courseId);
        allow update: if isLoggedIn()
          && request.auth.uid in resource.data.members;

        match /messages/{messageId} {
          allow read: if isTeacher()
            || (isLoggedIn() && request.auth.uid in get(/databases/$(database)/documents/courses/$(courseId)/chats/$(chatId)).data.members);
          allow create: if isLoggedIn()
            && request.auth.uid in get(/databases/$(database)/documents/courses/$(courseId)/chats/$(chatId)).data.members;
        }

        match /readBy/{userId} {
          allow read, write: if isLoggedIn() && request.auth.uid == userId;
          allow read: if isTeacher();
        }
      }
    }
    // Legacy global gamification (backward compat)
    match /gamification/{uid} {
      allow read: if isLoggedIn();
      allow write: if isOwner(uid) || isTeacher();
    }
    match /progress/{uid}/{document=**} {
      allow read: if isOwner(uid) || isTeacher();
      allow write: if isOwner(uid) || isTeacher();
    }
    // Weekly evidence log (photos + reflections per week per course)
    match /evidence/{uid}/courses/{courseId}/weeks/{weekKey} {
      allow read: if isOwner(uid) || isTeacher();
      allow write: if isOwner(uid);
    }
    // Telemetry buckets (daily engagement metrics per student per course)
    match /telemetry/{uid}/{document=**} {
      allow read: if isOwner(uid) || isTeacher();
      allow write: if isOwner(uid) || isTeacher();
    }
    match /enrollments/{enrollmentId} {
      allow read: if isLoggedIn();
      allow write: if isTeacher()
        || (isLoggedIn() && resource.data.email == request.auth.token.email);
    }
    match /chatLogs/{uid}/{document=**} {
      allow read: if isOwner(uid) || isTeacher();
      allow write: if isOwner(uid) || isTeacher();
    }
    match /rateLimits/{uid} {
      allow read, write: if isOwner(uid);
    }
  }
}
